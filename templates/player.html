<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    /* --- layout & bg --- */
    body {
      margin:0; color:#fff; font-family:Inter, sans-serif;
      min-height:100vh; display:flex; flex-direction:column; position:relative;
      background: url("https://graph.org/file/307d5dd37cbfb9738b41a-6cf2524b08e006f7bf.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    body::before {
      content:""; position:absolute; inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0));
      z-index:0;
    }
    .app-header, .player-screen, footer { position:relative; z-index:1; }
    .app-header { display:flex; justify-content:space-between; align-items:center; padding:12px 18px; font-size:18px; font-weight:700; background:rgba(0,0,0,0.25); }
    .listeners { font-size:13px; color:#ddd; }
    .player-screen { flex:1; padding-bottom:90px; text-align:center; }

    /* --- circular album with ring --- */
    .album-wrap { margin:20px auto; position:relative; width:280px; height:280px; display:flex; align-items:center; justify-content:center; }
    .album-ring {
      position:absolute; inset:0; border-radius:50%; padding:8px;
      background:conic-gradient(#6ea5ff 0deg, #a66bff 0deg, #ff6ea5 0deg, #333 0deg 360deg);
      display:flex; align-items:center; justify-content:center; transition:background .25s linear; overflow:hidden;
    }
    .album-ring::after {
      content:""; position:absolute; inset:-6px; border-radius:50%;
      background:conic-gradient(
        rgba(255,0,0,0.55),
        rgba(255,165,0,0.55),
        rgba(255,255,0,0.55),
        rgba(0,255,0,0.55),
        rgba(0,255,255,0.55),
        rgba(0,0,255,0.55),
        rgba(255,0,255,0.55),
        rgba(255,0,0,0.55)
      );
      filter: blur(12px);
      opacity:0.65;
      animation: rotateSweep 5s linear infinite, hueShift 6s linear infinite;
      mix-blend-mode:screen; z-index:1;
    }
    @keyframes rotateSweep { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    @keyframes hueShift { from{filter:blur(12px) hue-rotate(0deg)} to{filter:blur(12px) hue-rotate(360deg)} }

    .album-wrap img { width:240px; height:240px; border-radius:50%; object-fit:cover; border:6px solid #111; z-index:2; }

    /* --- track info --- */
    .track-info { margin-top:12px; padding: 0 20px; }
    .track-title { font-size:18px; font-weight:700; line-height:1.2; }
    .track-artist { font-size:14px; color:#ccc; margin-top:6px; }

    /* --- seek/controls/volume --- */
    .progress { display:flex; align-items:center; justify-content:center; gap:12px; margin:14px 0; }
    .progress span { width:40px; text-align:center; font-size:14px; color:#eee; }
    input[type=range] { -webkit-appearance:none; width:60%; height:8px; border-radius:8px; background:#444; outline:none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid #ff6ea5; cursor:pointer; }
    input[type=range]::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:#fff; border:3px solid #ff6ea5; cursor:pointer; }

    .controls { margin:12px 0; display:flex; justify-content:center; gap:18px; align-items:center; }
    .controls button{ font-size:22px; background:none; border:none; color:#fff; cursor:pointer; padding:6px; }
    .play-prim { font-size:28px; width:56px; height:56px; border-radius:28px; background:linear-gradient(90deg,#6ea5ff,#a66bff); color:#111; display:inline-flex; align-items:center; justify-content:center; border:none; cursor:pointer; }

    .volume-row{ margin:12px 0; text-align:center; }
    .volume-row span{ display:block; margin-top:6px; color:#ddd; }

    .user-profile { display:flex; align-items:center; gap:12px; margin:18px auto; max-width:320px; background:rgba(0,0,0,0.5); padding:12px 14px; border-radius:12px; }
    .user-profile img{ width:50px; height:50px; border-radius:50%; }
    .user-profile h3{ margin:0; font-size:16px; }
    .user-profile p{ margin:0; color:#bbb; font-size:13px; }

    footer{ position:fixed; bottom:0; left:0; right:0; background:rgba(0,0,0,0.7); display:flex; justify-content:space-around; padding:12px 0; z-index:2; }
    footer a{ color:#fff; text-decoration:none; font-size:16px; }

    /* small responsiveness */
    @media (max-width:420px){
      .album-wrap{ width:220px; height:220px; }
      .album-wrap img{ width:180px; height:180px; }
      input[type=range]{ width:70%; }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div>üé∂ BAD MUSIC</div>
    <div class="listeners"><span id="listenerCount">0</span> listeners</div>
  </header>

  <main class="player-screen">
    <div class="album-wrap">
      <div class="album-ring" id="albumRing"></div>
      <img id="player-thumb" src="{{ thumb }}" alt="Album">
    </div>

    <div class="track-info">
      <div class="track-title" id="title">{{ title }}</div>
      <div class="track-artist" id="artist">{{ artist }}</div>
    </div>

    <div class="listeners-row" id="listenersRow"></div>

    <div class="progress">
      <span id="current">0:00</span>
      <input id="seek" type="range" min="0" max="100" value="0" />
      <span id="total">0:00</span>
    </div>

    <div class="controls">
      <button class="ctrl" id="rewBtn" title="Rewind 10s">‚èÆ</button>
      <button id="playBtn" class="play-prim" title="Play/Pause">‚èµ</button>
      <button class="ctrl" id="fwdBtn" title="Forward 10s">‚è≠</button>
      <button id="favBtn" class="ctrl" title="Favorite">‚ù§Ô∏è</button>
    </div>

    <div class="volume-row">
      <input type="range" id="volume" min="0" max="1" step="0.01" value="0.8" />
      <span id="volPercent">80%</span>
    </div>

    <section class="user-profile">
      <img id="profile-pic" src="https://via.placeholder.com/60" alt="Profile">
      <div>
        <h3 id="profile-name">Guest</h3>
        <p id="profile-username">@guest</p>
      </div>
    </section>

    <audio id="audio" preload="metadata" src="{{ audio_url }}"></audio>
  </main>

  <footer>
    <a href="/">üè† Room</a>
    <a href="/me?uid=guest">üë§ Me</a>
  </footer>

  <script>
    // elements
    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const seek = document.getElementById('seek');
    const currentEl = document.getElementById('current');
    const totalEl = document.getElementById('total');
    const albumRing = document.getElementById('albumRing');
    const vol = document.getElementById('volume');
    const volPercent = document.getElementById('volPercent');
    const rewBtn = document.getElementById('rewBtn');
    const fwdBtn = document.getElementById('fwdBtn');

    // utility time format
    function fmtTime(sec){
      if (!isFinite(sec)) return '0:00';
      const m = Math.floor(sec/60);
      const s = Math.floor(sec % 60);
      return m + ':' + (s < 10 ? '0'+s : s);
    }

    // update play/pause icon
    function setPlayIcon(isPlaying){
      playBtn.textContent = isPlaying ? '‚è∏' : '‚ñ∂Ô∏è;
    }

    // try play safely (handle autoplay promise)
    async function safePlay(){
      try{
        await audio.play();
        setPlayIcon(true);
      }catch(err){
        // autoplay blocked ‚Äî mute & try, otherwise wait for user interaction
        console.warn('play blocked, will try when user interacts', err);
        audio.muted = true;
        try { await audio.play(); setPlayIcon(true); audio.muted = false; }
        catch(e){ setPlayIcon(false); }
      }
    }

    // toggle play/pause
    function togglePlay(){
      if(audio.paused){
        safePlay();
      } else {
        audio.pause();
        setPlayIcon(false);
      }
    }

    // rewind & forward (10s)
    function rewind(){ audio.currentTime = Math.max(0, audio.currentTime - 10); }
    function forward(){ audio.currentTime = Math.min(audio.duration || 0, audio.currentTime + 10); }

    // connect controls
    playBtn.addEventListener('click', togglePlay);
    rewBtn.addEventListener('click', () => { rewind(); updateUI(); });
    fwdBtn.addEventListener('click', () => { forward(); updateUI(); });

    // when metadata loaded -> set durations
    audio.addEventListener('loadedmetadata', () => {
      seek.max = Math.floor(audio.duration);
      totalEl.textContent = fmtTime(audio.duration);
    });

    // update UI on timeupdate
    function updateUI(){
      // seek/clock
      seek.value = Math.floor(audio.currentTime || 0);
      currentEl.textContent = fmtTime(audio.currentTime || 0);
      // circular ring progress (colorful)
      if(audio.duration){
        const progressDeg = (audio.currentTime / audio.duration) * 360;
        albumRing.style.background = `conic-gradient(#6ea5ff 0deg ${progressDeg/3}deg, #a66bff ${progressDeg/3}deg ${progressDeg*2/3}deg, #ff6ea5 ${progressDeg*2/3}deg ${progressDeg}deg, #333 ${progressDeg}deg 360deg)`;
        // seek bar colorful fill
        const pct = (audio.currentTime / audio.duration) * 100;
        seek.style.background = `linear-gradient(90deg, #6ea5ff, #a66bff, #ff6ea5 ${pct}%, #444 ${pct}%)`;
      }
    }
    audio.addEventListener('timeupdate', updateUI);

    // end -> reset icon
    audio.addEventListener('ended', () => { setPlayIcon(false); });

    // seek input
    let seeking = false;
    seek.addEventListener('input', (e) => {
      seeking = true;
      const val = +e.target.value;
      currentEl.textContent = fmtTime(val);
      // visual fill while dragging
      const max = +seek.max || 1;
      const pct = (val / max) * 100;
      seek.style.background = `linear-gradient(90deg, #6ea5ff, #a66bff, #ff6ea5 ${pct}%, #444 ${pct}%)`;
    });
    seek.addEventListener('change', (e) => {
      audio.currentTime = +e.target.value;
      seeking = false;
    });

    // volume handling with animated fill and percent
    function updateVolumeUI(){
      const percent = Math.round(vol.value * 100);
      volPercent.textContent = percent + '%';
      vol.style.background = `linear-gradient(90deg, #6ea5ff, #a66bff, #ff6ea5 ${percent}%, #444 ${percent}%)`;
      audio.volume = vol.value;
    }
    vol.addEventListener('input', updateVolumeUI);
    // init volume
    audio.volume = vol.value;
    updateVolumeUI();

    // listeners row loader (same as before)
    async function loadListeners(){
      try{
        const res = await fetch('/listeners');
        if(!res.ok) return;
        const data = await res.json();
        document.getElementById('listenerCount').textContent = data.count || 0;
        const row = document.getElementById('listenersRow');
        row.innerHTML = (data.users||[]).map(u => `<img src="${u.photo}" title="${u.name}" style="width:32px;height:32px;border-radius:50%;border:2px solid #444">`).join('');
      }catch(e){ console.warn('listeners error', e); }
    }
    setInterval(loadListeners, 5000);
    loadListeners();

    // ensure user interaction will unmute/play if blocked earlier
    // some browsers block unmuted autoplay. This listens for first tap to attempt play.
    function unlockPlayback(){
      if(audio.paused){
        safePlay();
      } else {
        // already playing; ensure muted false
        audio.muted = false;
      }
      // remove listeners (one-time)
      window.removeEventListener('click', unlockPlayback);
      window.removeEventListener('touchstart', unlockPlayback);
    }
    window.addEventListener('click', unlockPlayback, { once:true });
    window.addEventListener('touchstart', unlockPlayback, { once:true });

    // initialize UI: reflect audio initial state
    setPlayIcon(!audio.paused && !audio.ended);
    // If template loaded with audio_url and you want to autoplay try safePlay() here,
    // but leaving it commented to avoid autoplay blocks:
    // safePlay();
  </script>
</body>
</html>
